---
- name: Create smartctl-exporter directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: users
    mode: 0775
  loop:
    - "{{ podman_base_dir }}/smartctl-exporter"
    - "{{ podman_base_dir }}/smartctl-exporter/config"

# Disable running container if it is already running in systemd
- name: Disable smartctl-exporter container
  ansible.builtin.systemd:
    name: container-smartctl-exporter.service
    state: stopped
    enabled: false

- name: Deploy smartctl-exporter
  block:
    - name: Create smartctl-exporter config
      ansible.builtin.template:
        src: smartctl-exporter/smartctl-exporter.yaml.j2
        dest: "{{ podman_base_dir }}/smartctl-exporter/config/smartctl-exporter.yaml"
        owner: "{{ ansible_user }}"
        group: users
        mode: 0775
    - name: Create smartctl-exporter container
      containers.podman.podman_container:
        name: smartctl-exporter
        recreate: true
        privileged: true
        state: started
        image: quay.io/prometheuscommunity/smartctl-exporter:v0.10.0
        restart_policy: unless-stopped
        command:
          - --smartctl.path=/usr/sbin/smartctl
          - --smartctl.interval=120s
          - --web.listen-address=0.0.0.0:9633
          - --web.telemetry-path=/metrics
        volumes:
          - /dev:/hostdev
        ports:
          - 9633:9633
        generate_systemd:
          path: /etc/systemd/system
          restart_policy: always
          names: true
          new: true

- name: Enable smartctl-exporter container
  ansible.builtin.systemd:
    name: container-smartctl-exporter.service
    state: started
    enabled: true
