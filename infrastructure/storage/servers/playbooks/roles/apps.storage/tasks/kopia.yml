---
- name: Create kopia directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: users
    mode: 0775
  loop:
    - "{{ podman_base_dir }}/kopia"
    - "{{ podman_base_dir }}/kopia/cache"
    - "{{ podman_base_dir }}/kopia/config"
    - "{{ podman_base_dir }}/kopia/logs"

# Disable running container if it is already running in systemd
- name: Disable kopia container
  ansible.builtin.systemd:
    name: container-kopia.service
    state: stopped
    enabled: false

- name: Create kopia container
  containers.podman.podman_container:
    name: kopia
    recreate: true
    privileged: false
    state: started
    image: docker.io/kopia/kopia:0.14.1
    restart_policy: unless-stopped
    env:
      KOPIA_PASSWORD: "{{ SECRET_KOPIA_PASSWORD }}"
      TZ: America/New_York
    command:
      - server
      - --insecure
      - --address
      - 0.0.0.0:51515
      - --override-hostname
      - "osiris.{{ SECRET_PRIVATE_DOMAIN }}"
      - --override-username
      - twitlin
      - --without-password
    ports:
      - 51515:51515
    volumes:
      - "{{ podman_base_dir }}/kopia/config:/app/config"
      - "{{ podman_base_dir }}/kopia/cache:/app/cache"
      - "{{ podman_base_dir }}/kopia/logs:/app/logs"
      - /pluto:/pluto:ro
    generate_systemd:
      restart_policy: always
      names: true
      path: /etc/systemd/system
      new: true

- name: Enable kopia container
  ansible.builtin.systemd:
    name: container-kopia.service
    state: started
    enabled: true
