---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app tetragon
  namespace: tetragon-system
spec:
  interval: 15m
  chart:
    spec:
      chart: tetragon
      version: 0.8.0
      sourceRef:
        kind: HelmRepository
        name: cilium-charts
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    # Allowlist for JSON export. For example, to export only process_connect events from
    # the default namespace:
    #
    # exportAllowList: |
    #   {"namespace":["default"],"event_set":["PROCESS_EXEC"]}
    exportAllowList: |-
      {"event_set":["PROCESS_EXEC", "PROCESS_EXIT", "PROCESS_KPROBE"]}
    # Denylist for JSON export. For example, to exclude exec events that look similar to
    # Kubernetes health checks and all the events from kube-system namespace and the host:
    #
    # exportDenyList: |
    #   {"health_check":true}
    #   {"namespace":["kube-system",""]}
    #
    exportDenyList: |-
      {"health_check":true}
      {"namespace":["", "cilium", ""]}
    # Access Kubernetes API to associate Tetragon events with Kubernetes pods.
    enableK8sAPI: true
    # Access Cilium API to associate Tetragon events with Cilium endpoints and DNS cache.
    enableCiliumAPI: false
    # enableProcessCred enables Capabilities visibility in exec and kprobe events.
    enableProcessCred: true
    # enableProcessNs enables Namespaces visibility in exec and kprobe events.
    enableProcessNs: true
    prometheus:
      # -- Whether to enable exposing Tetragon metrics.
      enabled: true
      serviceMonitor:
        # -- Whether to create a 'ServiceMonitor' resource targeting the 'tetragon' pods.
        enabled: true
