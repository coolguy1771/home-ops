name: Pulumi
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths: ["pulumi/*"]
jobs:
  preview:
    name: Preview
    runs-on: ["arc-runner-set-home-ops"]
    permissions:
      pull-requests: write
    strategy:
      matrix:
        path: ["pulumi/sol"]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      - name: Setup Node LTS ✨
        uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65 # v4
        with:
          node-version: lts/*
      - name: Installing dependencies
        working-directory: ${{ matrix.path }}
        run: npm install
      - name: Extract stack
        id: extract_path
        run: |
          echo "::set-output name=segment::$(echo "${{ matrix.path }}" | awk -F'/' '{print $NF}')"
      - uses: pulumi/actions@1d3ebd326317f249313706eeb489c9ed7c036443 # v4
        with:
          command: preview
          comment-on-pr: true
          comment-on-summary: true
          work-dir: ${{ matrix.path }}
          stack-name: k8s
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  deploy:
    name: Deploy
    runs-on: ["arc-runner-set-home-ops"]
    permissions:
      contents: read
    needs: preview
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    strategy:
      matrix:
        path: ["pulumi/sol"]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      - name: Setup Node LTS ✨
        uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65 # v4
        with:
          node-version: lts/*
      - name: Installing dependencies
        working-directory: ${{ matrix.path }}
        run: npm install
      - name: Extract stack
        id: extract_path
        run: |
          echo "::set-output name=segment::$(echo "${{ matrix.path }}" | awk -F'/' '{print $NF}')"
      - uses: pulumi/actions@1d3ebd326317f249313706eeb489c9ed7c036443 # v4
        with:
          command: up
          comment-on-summary: true
          work-dir: ${{ matrix.path }}
          stack-name: k8s
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
