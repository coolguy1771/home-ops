---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app kiali-operator
  namespace: istio-system
spec:
  interval: 15m
  chart:
    spec:
      chart: kiali-operator
      version: 1.89.0
      sourceRef:
        kind: HelmRepository
        name: kiali
        namespace: flux-system
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    resources:
      requests:
        cpu: "10m"
        memory: "64Mi"
    replicaCount: 2
    # For what a Kiali CR spec can look like, see:
    # https://github.com/kiali/kiali-operator/blob/master/deploy/kiali/kiali_cr.yaml
    cr:
      create: true
      name: kiali
      namespace: "istio-system"
      annotations: {}
      spec:
        deployment:
          replicas: 2
          accessible_namespaces:
          - '**'
        auth:
          strategy: "anonymous"
        istio_namespace: "istio-system"
        external_services:
          istio:
            root_namespace: istio-system
          prometheus:
            url: http://thanos-query.monitoring.svc.cluster.local:10902
          thanos_proxy:
            enabled: true
            retention_period: "7d"
            scrape_interval: "30s"
          grafana:
            enabled: true
            in_cluster_url: http://grafana.monitoring.svc.cluster.local/
            # Public facing URL of Grafana
            url: https://grafana.${SECRET_PUBLIC_DOMAIN}
