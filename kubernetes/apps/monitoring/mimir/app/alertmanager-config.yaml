---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mimir-alertmanager-config
data:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      group_by:
        - alertname
        - job
      group_interval: 10m
      group_wait: 1m
      receiver: pushover
      repeat_interval: 12h
      routes:
        - receiver: "null"
          matchers:
            - alertname = "InfoInhibitor"
        # - receiver: heartbeat
        #   group_interval: 5m
        #   group_wait: 0s
        #   repeat_interval: 5m
        #   matchers:
        #     - alertname = "Watchdog"
        - receiver: pushover
          matchers:
            - severity = "critical"

    inhibit_rules:
      - equal:
          - alertname
          - namespace
        source_matchers:
          - severity = "critical"
        target_matchers:
          - severity = "warning"

    receivers:
      - name: "null"

      # - name: heartbeat
      #   webhook_configs:
      #     - url: ${SPOODERMON_HEARTBEAT_URL}
      #       http_config:
      #         authorization:
      #           credentials: ${SPOODERMON_HEARTBEAT_TOKEN}

      - name: pushover
        pushover_configs:
          - token_file: /secrets/alertmanager-secret/ALERTMANAGER_PUSHOVER_TOKEN
            user_key_file: /secrets/alertmanager-secret/PUSHOVER_USER_KEY
            html: true
            send_resolved: true
            sound: gamelan
            priority: '{{ if eq .Status "firing" }}1{{ else }}0{{ end }}'
            title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}'
            url_title: View in Alertmanager
            ttl: 86400s
            message: |
              {{- range .Alerts }}
                {{- if ne .Annotations.description "" }}
                  {{ .Annotations.description }}
                {{- else if ne .Annotations.summary "" }}
                  {{ .Annotations.summary }}
                {{- else if ne .Annotations.message "" }}
                  {{ .Annotations.message }}
                {{- else }}
                  Alert description not available
                {{- end }}
                {{- if gt (len .Labels.SortedPairs) 0 }}
                  <small>
                    {{- range .Labels.SortedPairs }}
                      <b>{{ .Name }}:</b> {{ .Value }}
                    {{- end }}
                  </small>
                {{- end }}
              {{- end }}
