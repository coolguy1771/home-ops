---
# Secret used as global_config for mimir.alerts.kubernetes. Pushover credentials
# live here so the AlertmanagerConfig CRD has no secret refs (avoids Alloy bug).
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: alertmanager-global-config
  namespace: monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: alertmanager-global-config
  dataFrom:
    - extract:
        key: alertmanager
    - extract:
        key: pushover
  template:
    engineVersion: v2
    data:
      config: |
        global:
          resolve_timeout: 5m
        route:
          receiver: "null"
        receivers:
        - name: "null"
        - name: pushover
          pushover_configs:
          - token: "{{ .ALERTMANAGER_PUSHOVER_TOKEN }}"
            user_key: "{{ .PUSHOVER_USER_KEY }}"
            html: true
            send_resolved: true
            sound: gamelan
            ttl: 86400s
            url_title: View in Alertmanager
            priority: "0"
            title: '{{ "{{ .Status | toUpper }}" }} {{ "{{ .CommonLabels.alertname }}" }}'
            message: '{{ "{{ range .Alerts }}" }}{{ "{{ .Annotations.summary }}" }}{{ "{{ end }}" }}'
